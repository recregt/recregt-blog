{{- /* Favicons for different devices */ -}}
<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
<link rel="manifest" href="/images/site.webmanifest">
<link rel="shortcut icon" href="/images/favicon.ico">

{{- /* Open Graph image for social media */ -}}
<meta property="og:image" content="{{ .Site.BaseURL }}images/og-image.jpg">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="{{ .Site.BaseURL }}images/og-image.jpg">

{{- /* Custom styles for external link icon and accessibility */ -}}
<style>
    /* External link styling for menu */
    #menu a[href^="http"]:not([href*="notes.recregt.com"]) {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    /* Make the arrow icon more visible */
    #menu a[href^="http"]:not([href*="notes.recregt.com"])::after {
        font-size: 0.85em;
        opacity: 0.7;
    }

    /* Screen reader only class for accessibility */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Better focus indicators for accessibility */
    .top-link:focus,
    #theme-toggle:focus,
    .toc summary:focus {
        outline: 2px solid var(--theme, #007acc);
        outline-offset: 2px;
    }

    #searchbox input:focus {
        outline: 2px solid var(--theme, #007acc);
        outline-offset: 2px;
    }

    /* Skip to main content link */
    .skip-to-main:focus {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 9999;
        background: var(--theme, #007acc);
        color: white;
        padding: 8px 12px;
        text-decoration: none;
        border-radius: 4px;
        width: auto;
        height: auto;
        clip: auto;
        overflow: visible;
    }

    /* Lessons list layout */
    .lessons-list{display:flex;flex-direction:column;gap:1.5rem;margin-top:2rem}
    .lesson-item,.lesson-category{display:block;padding:1.25rem;border:1px solid var(--border);border-radius:8px;transition:all .2s ease;text-decoration:none;color:inherit}
    .lesson-item:hover,.lesson-category:hover{border-color:var(--tertiary);box-shadow:0 2px 8px rgba(0,0,0,.1);transform:translateY(-2px)}
    .lesson-item article,.lesson-category article{margin:0}
    .lesson-title{margin:0 0 .75rem 0;font-size:1.25rem;font-weight:600;color:var(--primary)}
    .lesson-description{color:var(--secondary);font-size:.95rem;line-height:1.6;margin:0}
    .lesson-category{background:var(--code-bg)}
    .lesson-category .lesson-title{font-size:1.35rem}

    /* Mobile responsive improvements for math and content */
    @media screen and (max-width: 768px) {
        /* Prevent horizontal scroll on mobile */
        .post-content {
            overflow-x: hidden;
        }
        
        /* Math display improvements */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            margin: 0.8em -1rem;
            padding: 0 1rem;
        }
        
        /* Smaller font for math on mobile */
        .katex {
            font-size: 1.05em !important;
        }
        
        /* Better scrollbar for math on mobile */
        .katex-display::-webkit-scrollbar {
            height: 5px;
        }
        
        .katex-display::-webkit-scrollbar-track {
            background: var(--code-bg);
            border-radius: 3px;
        }
        
        .katex-display::-webkit-scrollbar-thumb {
            background: var(--tertiary);
            border-radius: 3px;
        }
        
        /* Code blocks responsive */
        pre {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Reduce padding on mobile for better space usage */
        .post-content h2,
        .post-content h3 {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Lists with math content */
        .post-content li {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
    }

    /* Extra small screens */
    @media screen and (max-width: 480px) {
        .katex {
            font-size: 1em !important;
        }
        
        .katex-display {
            margin: 0.6em -0.5rem;
            padding: 0 0.5rem;
        }
    }
</style>

{{- /* DNS prefetch and preconnect for external resources */ -}}
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

{{- /* Service Worker for caching external resources */ -}}
<script>
// Register service worker for performance optimization
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js')
      .then(function(registration) {
        console.log('SW registered: ', registration);
      })
      .catch(function(registrationError) {
        console.log('SW registration failed: ', registrationError);
      });
  });
}

// Performance optimization: Handle Cloudflare email decode efficiently
(function() {
    // Defer Cloudflare email decode to prevent render blocking
    var cfEmailScript = document.querySelector('script[data-cfasync="false"][src*="email-decode"]');
    if (cfEmailScript) {
        cfEmailScript.defer = true;
    }
    
    // Alternative: Load email decode after critical path
    window.addEventListener('load', function() {
        if (typeof cloudflare !== 'undefined' && cloudflare.init) {
            cloudflare.init();
        }
    });
})();
</script>

{{- if .Param "math" }}
{{- /* Critical KaTeX CSS inline - no VS Code linter errors */ -}}
<style>
/* Critical KaTeX styles for immediate rendering */
.katex{font:normal 1.21em KaTeX_Main,"Times New Roman",serif;line-height:1.2;text-indent:0;text-rendering:auto;border-color:currentColor}.katex *{-ms-high-contrast-adjust:none!important;border-color:currentColor}.katex .katex-mathml{position:absolute;clip:rect(1px,1px,1px,1px);padding:0;border:0;height:1px;width:1px;overflow:hidden}.katex .katex-html>.newline{display:block}.katex .base{position:relative;white-space:nowrap;width:min-content}.katex .strut{display:inline-block}.katex .textbf{font-weight:bold}.katex .textit{font-style:italic}.katex .mathnormal{font-family:KaTeX_Math,"Times New Roman",serif;font-style:italic}.katex .mathit{font-family:KaTeX_Main,"Times New Roman",serif;font-style:italic}.katex .mathrm{font-style:normal}.katex-display{display:block;margin:1em 0;text-align:center;overflow-x:auto;overflow-y:hidden}.katex-display>.katex{display:block;white-space:nowrap;text-align:left;padding-bottom:0.3em}
</style>

{{- /* Load KaTeX from local vendor directory (v0.16.25) - Self-hosted for security */ -}}
<link rel="stylesheet" href="/vendor/katex/katex.min.css">

{{- /* Load KaTeX JavaScript with defer for better performance */ -}}
<script defer src="/vendor/katex/katex.min.js"></script>
<script defer src="/vendor/katex/contrib/auto-render.min.js" onload="renderKaTeXMath()"></script>


<script>
// Render math after auto-render script loads
function renderKaTeXMath() {
    console.log('KaTeX auto-render loaded, rendering math...');
    try {
        renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: String.raw`\(`, right: String.raw`\)`, display: false},
                {left: String.raw`\[`, right: String.raw`\]`, display: true}
            ],
            throwOnError: false,
            strict: false,
            trust: true,
            ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        });
        console.log('KaTeX rendering completed successfully');
    } catch (error) {
        console.error('KaTeX rendering error:', error);
    }
}
</script>
{{- end }}